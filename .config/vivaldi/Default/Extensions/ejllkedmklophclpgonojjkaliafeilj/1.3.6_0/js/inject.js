window.TextCursor||(window.TextCursor=function(n,t){this.fillStyle=n||"rgba(0, 0, 0, 0.7)",this.width=t||2,this.left=0,this.top=0},window.TextCursor.prototype={getHeight:function(n){var t=n.measureText("W").width;return t+t/6},createPath:function(e){e.beginPath(),e.rect(this.left,this.top,this.width,this.getHeight(e))},draw:function(n,t,e){n.save(),this.left=t,this.top=e-this.getHeight(n),this.createPath(n),n.lineWidth=1,n.fillStyle=this.fillStyle,n.fill(),n.restore()},erase:function(e){window.NOTEPAD.restoreCanvas([this.left-1,this.top,this.width+2,this.getHeight(e)])}}),window.TextLine||(window.TextLine=function(n,t){this.text="",this.left=n,this.bottom=t,this.caret=0},window.TextLine.prototype={insert:function(n){var t=this.text.slice(0,this.caret),o=this.text.slice(this.caret);t+=n,this.text=t,this.text+=o,this.caret+=n.length},getCaretX:function(n){var t=this.text.substring(0,this.caret),e=n.measureText(t).width;return this.left+e},removeCharacterBeforeCaret:function(){0!==this.caret&&(this.text=this.text.substring(0,this.caret-1)+this.text.substring(this.caret),this.caret--)},removeLastCharacter:function(){this.text=this.text.slice(0,-1)},getWidth:function(e){return e.measureText(this.text).width},getHeight:function(n){var t=n.measureText("W").width;return t+t/6},draw:function(e){e.save(),e.textAlign="start",e.textBaseline="bottom",e.lineWidth=1,e.strokeText(this.text,this.left,this.bottom),e.fillText(this.text,this.left,this.bottom),e.restore()},erase:function(){window.NOTEPAD.restoreCanvas()}}),window.Paragraph||(window.Paragraph=function(o,t,e,a,n){this.context=o,this.drawingSurface=a,this.left=t,this.top=e,this.lines=[],this.activeLine=void 0,this.cursor=n,this.blinkingInterval=void 0},window.Paragraph.prototype={clearIntervals:function(e){this.blinkingInterval=window.clearInterval(this.blinkingInterval),this.blinkingTimeout=window.clearTimeout(this.blinkingTimeout),this.cursor.erase(this.context,this.drawingSurface),"function"!=typeof e||this.blinkingInterval?this.blinkingInterval&&this.clearIntervals(e):e()},isPointInside:function(n){var t=this.context;return t.beginPath(),t.rect(this.left,this.top,this.getWidth(),this.getHeight()),t.isPointInPath(n.x,n.y)},getHeight:function(){var n=0;return this.lines.forEach(Function.prototype.bind.call(function(e){n+=e.getHeight(this.context)},this)),n},getWidth:function(){var n=0,o=0;return this.lines.forEach(Function.prototype.bind.call(function(e){n=e.getWidth(this.context),o<n&&(o=n)},this)),o},draw:function(){this.lines.forEach(Function.prototype.bind.call(function(e){e.draw(this.context)},this))},erase:function(){window.NOTEPAD.restoreCanvas()},addLine:function(e){this.lines.push(e),this.activeLine=e,this.moveCursor(e.left,e.bottom)},insert:function(n){this.erase(this.context,this.drawingSurface),this.activeLine.insert(n);var t=this.activeLine.text.substring(0,this.activeLine.caret),e=this.context.measureText(t).width;this.moveCursor(this.activeLine.left+e,this.activeLine.bottom),this.draw(this.context)},blinkCursor:function(){var t=this;this.blinkingInterval&&(this.blinkingInterval=window.clearInterval(this.blinkingInterval)),this.blinkingInterval=setInterval(function(){var n=window.NOTEPAD.drawOptions[window.NOTEPAD.selectedDrawOption];n&&("text"===n.type?(t.cursor.erase(t.context,t.drawingSurface),t.blinkingTimeout&&(t.blinkingTimeout=window.clearTimeout(t.blinkingTimeout)),t.blinkingTimeout=setTimeout(function(){t.cursor.draw(t.context,t.cursor.left,t.cursor.top+t.cursor.getHeight(t.context))},200)):t.blinkingInterval=window.clearInterval(t.blinkingInterval))},900)},moveCursorCloseTo:function(n,t){var e=this.getLine(t);e&&(e.caret=this.getColumn(e,n),this.activeLine=e,this.moveCursor(e.getCaretX(this.context),e.bottom))},moveCursor:function(n,t){this.cursor.erase(this.context,this.drawingSurface),this.cursor.draw(this.context,n,t),this.blinkingInterval||this.blinkCursor(n,t)},moveLinesDown:function(n){for(var t,o=n;o<this.lines.length;++o)t=this.lines[o],t.bottom+=t.getHeight(this.context)},newline:function(){var r,l,c=this.activeLine.text.substring(0,this.activeLine.caret),i=this.activeLine.text.substring(this.activeLine.caret),n=this.context.measureText("W").width+this.context.measureText("W").width/6,s=this.activeLine.bottom+n;this.erase(this.context,this.drawingSurface),this.activeLine.text=c,(l=new TextLine(this.activeLine.left,s)).insert(i),r=this.lines.indexOf(this.activeLine),this.lines.splice(r+1,0,l),this.activeLine=l,this.activeLine.caret=0;for(var o=(r=this.lines.indexOf(this.activeLine))+1;o<this.lines.length;++o)(l=this.lines[o]).bottom+=n;this.draw(),this.cursor.draw(this.context,this.activeLine.left,this.activeLine.bottom)},getLine:function(n){for(var t,o=0;o<this.lines.length;++o)if(n>(t=this.lines[o]).bottom-t.getHeight(this.context)&&n<t.bottom)return t},getColumn:function(r,t){var e,l,c,d,p=!1;for((c=new TextLine(r.left,r.bottom)).insert(r.text);!p&&0<c.text.length;)e=c.left+c.getWidth(this.context),c.removeLastCharacter(),(l=c.left+c.getWidth(this.context))<t&&(d=(t-l<e-t?l:e)===e?c.text.length+1:c.text.length,p=!0);return d},activeLineIsOutOfText:function(){return 0===this.activeLine.text.length},activeLineIsTopLine:function(){return this.lines[0]===this.activeLine},moveUpOneLine:function(){var o,a;o=""+this.activeLine.text;var r=this.lines.indexOf(this.activeLine);this.activeLine=this.lines[r-1],this.activeLine.caret=this.activeLine.text.length,this.lines.splice(r,1),this.moveCursor(this.activeLine.left+this.activeLine.getWidth(this.context),this.activeLine.bottom),this.activeLine.text+=o;for(var i=r;i<this.lines.length;++i)(a=this.lines[i]).bottom-=a.getHeight(this.context)},backspace:function(){var n,o;this.context.save(),0===this.activeLine.caret?this.activeLineIsTopLine()||(this.erase(this.context,this.drawingSurface),this.moveUpOneLine(),this.draw()):(this.erase(this.context,this.drawingSurface),this.activeLine.removeCharacterBeforeCaret(),n=this.activeLine.text.slice(0,this.activeLine.caret),o=this.context.measureText(n).width,this.moveCursor(this.activeLine.left+o,this.activeLine.bottom),this.draw(this.context),this.context.restore())}}),Function.prototype.bind||(Function.prototype.bind=function(o){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),e=this,a=function(){},n=function(){return e.apply(this instanceof a&&o?this:o,t.concat(Array.prototype.slice.call(arguments)))};return a.prototype=this.prototype,n.prototype=new a,n});var getCSSAnimationManager=function(){for(var r,l,c,d=!1,p=["webkit","Moz","O",""],s=p.length,u=document.documentElement.style;s--;)if(p[s]){if(void 0!==u[p[s]+"AnimationName"]){switch(r=p[s],s){case 0:l=r.toLowerCase()+"AnimationStart",c=r.toLowerCase()+"AnimationEnd",d=!0;break;case 1:l="animationstart",c="animationend",d=!0;break;case 2:l=r.toLowerCase()+"animationstart",c=r.toLowerCase()+"animationend",d=!0;}break}}else if(void 0!==u.animationName){r=p[s],l="animationstart",c="animationend",d=!0;break}return{supported:d,prefix:r,start:l,end:c}};!function(n,t){"undefined"!=typeof unsafeWindow&&null!==unsafeWindow?unsafeWindow.CTRL_HIDDEN?n.NOTEPAD.showControlPanel():unsafeWindow.NOTEPAD_INIT||(n.NOTEPAD=t(n),n.NOTEPAD.init()):(void 0!==n.NOTEPAD&&null!==n.NOTEPAD||(n.NOTEPAD=t(n)),n.NOTEPAD.controlPanelHidden?n.NOTEPAD.showControlPanel():n.NOTEPAD.initialized||n.NOTEPAD.init())}("undefined"==typeof window?this:window,function(p){var v=Math.round,y=Math.max,m=function(){this.MAX_ITEMS=50,this.currentIndex=0,this.array=[]};m.prototype.add=function(n){if(this.currentIndex<this.array.length-1?(this.array[++this.currentIndex]=n,this.array=this.array.slice(0,this.currentIndex+1)):(this.array.push(n),this.currentIndex=this.array.length-1),this.array.length>this.MAX_ITEMS){var t=this.array.length-this.MAX_ITEMS;this.array=this.array.splice(-this.MAX_ITEMS),this.currentIndex-=t}},m.prototype.previous=function(){return 0===this.currentIndex?null:this.array[--this.currentIndex]},m.prototype.next=function(){return this.currentIndex===this.array.length-1?null:this.array[++this.currentIndex]},m.prototype.hasPrevious=function(){return 0<this.currentIndex},m.prototype.hasNext=function(){return this.currentIndex<this.array.length-1};var n="undefined"==typeof chrome?"undefined"==typeof browser?void 0:browser:chrome,o={canvas:null,context:null,buffer:null,initialized:!1,controlPanelHidden:!1,persistTimer:null,history:null,config:{},drawOptions:[{type:"pen",title:"Pencil - draw a custom line"},{type:"eyedropper",title:"Color picker - pick a color from the web page or your drawings and use it for drawing"},{type:"text",font:"Arial",minSize:15,maxSize:50,title:"Text - insert text"},{type:"line",title:"Line - draw a straight line"},{type:"arrow",title:"Arrow - create arrow on the canvas"},{type:"quadratic_curve",title:"Quadratic curve - draw a quadratic curve",iteration:0,initLoc:null,lastLoc:null},{type:"bezier_curve",title:"Bezier curve - draw a bezier curve",iteration:0,initLoc:null,firstPoint:null,lastPoint:null},{type:"polygon",title:"Polygon - draw a polygon",initLoc:null,lastLoc:null},{type:"circle",title:"Ellipse - draw an ellipse or a circle"},{type:"rectangle",title:"Rectangle - draw a rectangle or a square"},{type:"cursor",title:"Cursor - interact with the web page"},{type:"eraser",title:"Eraser - erase part of your drawings",width:30,height:30},{type:"fill",title:"Paint Bucket - fill an area"}],selectedDrawOption:null,selectedColorOption:null,selectedAlphaOption:null,mousedown:!1,lastMouseDownLoc:null,drawingSurfaceImageData:null,resizeTimeoutID:null,cursor:new TextCursor,paragraph:null,panel:null,browser:{isChrome:/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)},createCanvas:function(){this.canvas=p.document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.setAttribute("id","NOTEPAD"),this.browser.isChrome||(this.buffer=document.createElement("canvas")),p.document.body.appendChild(this.canvas),p.addEventListener("resize",this.resizeBinded),p.addEventListener("scroll",this.resizeBinded);var n=localStorage.getItem("WP_CRX_STORAGE_SNAPSHOT_"+p.location.pathname);if(n){var t=new Image;t.onload=Function.prototype.bind.call(this.initCanvas,this,t),t.src=n}else this.initCanvas()},initCanvas:function(e){e?(this.handleResize(!0),this.context.drawImage(e,0,0),this.storeCanvas(!0)):this.handleResize(),this.storeHistory()},checkHistoryButtonStatus:function(){this.nextBtn&&this.backBtn&&(this.history.hasNext()?this.removeClass(this.nextBtn,"disabled"):this.addClass(this.nextBtn,"disabled"),this.history.hasPrevious()?this.removeClass(this.backBtn,"disabled"):this.addClass(this.backBtn,"disabled"))},storeHistory:function(){this.history.add(this.context.getImageData(0,0,this.canvas.width,this.canvas.height)),this.checkHistoryButtonStatus()},handleBackButtonClick:function(){this.history.hasPrevious()&&(this.finishLastDrawing(),this.context.putImageData(this.history.previous(),0,0),this.storeCanvas(),this.checkHistoryButtonStatus())},handleForwardButtonClick:function(){this.history.hasNext()&&(this.finishLastDrawing(),this.context.putImageData(this.history.next(),0,0),this.storeCanvas(),this.checkHistoryButtonStatus())},persistLocalStorage:function(){var t=this.canvas.toDataURL();try{p.localStorage.setItem("WP_CRX_STORAGE_SNAPSHOT_"+p.location.pathname,t)}catch(e){try{p.localStorage.clear(),p.localStorage.setItem("WP_CRX_STORAGE_SNAPSHOT_"+p.location.pathname,t)}catch(e){}}},storeCanvas:function(e){this.buffer=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),e||(this.persistTimer&&(this.persistTimer=p.clearInterval(this.persistTimer)),this.persistTimer=p.setTimeout(this.persistLocalStorageBinded,500))},restoreCanvas:function(e){e?(this.context.clearRect.apply(this.context,e),e.unshift(this.buffer,0,0),e[e.length-1]+=1,e[e.length-2]+=1,this.context.putImageData.apply(this.context,e)):(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.putImageData(this.buffer,0,0))},handlePanelAppearing:function(e){e.target.style.opacity=1},handleResize:function(r){var t=Math.min,l=!1,c=p.pageYOffset||document.documentElement.scrollTop,i=(p.innerHeight||document.documentElement.clientHeight,this.context.lineWidth),n=y(document.documentElement.clientWidth,document.body.scrollWidth,document.documentElement.scrollWidth,document.body.offsetWidth,document.documentElement.offsetWidth),s=y(document.documentElement.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight),o=t(s-this.canvas.offsetTop,5e3);5e3<c-this.canvas.offsetTop?(o=t(s-c,5e3),this.canvas.style.top=c+"px",l=!0):c<this.canvas.offsetTop&&(o=5e3,this.canvas.style.top=y(0,5e3*Math.floor(c/5e3))+"px",l=!0),l?(this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.paragraph&&(this.paragraph.clearIntervals(),this.paragraph=null),this.storeCanvas(!0)):this.storeCanvas(r),this.canvas.width=n,this.canvas.height=o,l||this.restoreCanvas(),this.updatePaintStyle(),this.context.lineWidth=i},createControlPanel:function(){this.panel=p.document.createElement("div"),this.backBtn=p.document.createElement("div"),this.nextBtn=p.document.createElement("div");var n=p.document.createElement("div"),t=p.document.createElement("div"),e=p.document.createElement("div"),i=p.document.createElement("div"),s=p.document.createElement("div"),g=p.document.createElement("div");this.panel.setAttribute("id","NOTEPAD_controls"),n.setAttribute("class","NOTEPAD_controls_draw"),t.setAttribute("class","NOTEPAD_controls_color"),e.setAttribute("class","NOTEPAD_controls_control"),i.setAttribute("class","NOTEPAD_controls_range_wrapper"),s.setAttribute("class","NOTEPAD_controls_range alpha_control"),g.setAttribute("class","NOTEPAD_controls_range size_control"),p.document.body.appendChild(this.panel),this.panel.appendChild(n),this.panel.appendChild(t),i.appendChild(s),i.appendChild(g),this.panel.appendChild(i),this.panel.appendChild(e);for(var x=0;x<this.drawOptions.length;x++){var y=this.drawOptions[x],a=p.document.createElement("div");a.setAttribute("class","NOTEPAD_controls_draw_option"),a.setAttribute("title",y.title),this.addClass(a,y.type),a.addEventListener("click",Function.prototype.bind.call(this.onControlPanelClick,this,x)),n.appendChild(a),(null!==this.config.tool&&void 0!==this.config.tool||0!=x)&&x!==this.config.tool||this.triggerClick(a)}const r=document.createElement("div");r.setAttribute("class","settings_btn"),r.setAttribute("title","Settings - open settings page"),r.addEventListener("click",this.handleOptionsClick),this.panel.insertAdjacentElement("afterbegin",r),this.colorPicker=p.document.createElement("input"),this.colorPicker.setAttribute("type","color"),this.colorPicker.value=this.config.color||"#40c0eb",this.colorPicker.setAttribute("title","Select a color"),this.colorPicker.addEventListener("change",Function.prototype.bind.call(this.onColorPanelClick,this),!1),t.appendChild(this.colorPicker),this.alphaPicker=p.document.createElement("input"),this.alphaPicker.setAttribute("type","range"),this.alphaPicker.setAttribute("min","0"),this.alphaPicker.setAttribute("max","1"),this.alphaPicker.setAttribute("step","0.01"),this.alphaPicker.value=null!==this.config.alpha&&void 0!==this.config.alpha?this.config.alpha:1,this.alphaPicker.setAttribute("title","Select transparency"),this.alphaPicker.addEventListener("change",Function.prototype.bind.call(this.onAlphaChange,this),!1),this.alphaPicker.addEventListener("input",Function.prototype.bind.call(this.onAlphaUpdate,this),!1),this.alphaPickerPreview=p.document.createElement("p"),s.appendChild(this.alphaPicker),s.appendChild(this.alphaPickerPreview);var m=p.document.createElement("input");m.setAttribute("type","range"),m.setAttribute("min","1"),m.setAttribute("max","20"),m.setAttribute("step","1"),m.value=this.config.thickness||1,m.setAttribute("title","Select line width"),m.addEventListener("change",Function.prototype.bind.call(this.onLineChange,this),!1),m.addEventListener("input",Function.prototype.bind.call(this.onLineUpdate,this),!1),this.linePickerPreview=p.document.createElement("p"),g.appendChild(m),g.appendChild(this.linePickerPreview),this.selectedColorOption=this.hexToRgb(this.colorPicker.value),this.selectedAlphaOption=this.alphaPicker.value,this.context.lineWidth=m.value,this.alphaPickerPreview.innerHTML=v(100*this.selectedAlphaOption)+"%",this.linePickerPreview.innerHTML=v(100*(this.context.lineWidth/20))+"%",this.updatePaintStyle();var h=p.document.createElement("div"),c=p.document.createElement("div"),l=p.document.createElement("div"),d=p.document.createElement("div");h.setAttribute("class","NOTEPAD_controls_control_option prtBtn"),h.setAttribute("title","Take a screenshot of the current web page with your drawings"),c.setAttribute("class","NOTEPAD_controls_control_option exitBtn"),c.setAttribute("title","Quit"),this.backBtn.setAttribute("class","NOTEPAD_controls_control_option backBtn"),this.backBtn.setAttribute("title","Step backward"),this.nextBtn.setAttribute("class","NOTEPAD_controls_control_option nextBtn"),this.nextBtn.setAttribute("title","Step forward"),l.setAttribute("class","NOTEPAD_controls_control_option eraseAllBtn"),l.setAttribute("title","Erase all"),d.setAttribute("class","NOTEPAD_controls_control_option hideCtrlBtn"),d.setAttribute("title","Close control panel (Click the extension icon to re-open)"),h.addEventListener("click",Function.prototype.bind.call(this.onPrintButtonClick,this)),c.addEventListener("click",Function.prototype.bind.call(this.exit,this)),this.backBtn.addEventListener("click",Function.prototype.bind.call(this.handleBackButtonClick,this)),this.nextBtn.addEventListener("click",Function.prototype.bind.call(this.handleForwardButtonClick,this)),l.addEventListener("click",Function.prototype.bind.call(this.eraseAll,this)),d.addEventListener("click",Function.prototype.bind.call(this.hideControlPanel,this)),e.appendChild(this.backBtn),e.appendChild(this.nextBtn),e.appendChild(l),e.appendChild(h),e.appendChild(d),e.appendChild(c),this.checkHistoryButtonStatus(),this.CSSAnimationManager.supported?this.panel.addEventListener(this.CSSAnimationManager.end,Function.prototype.bind.call(this.handlePanelAppearing,this),!1):this.panel.style.opacity=1},handleOptionsClick:function(){chrome.runtime.sendMessage({method:"open_options"})},finishLastDrawing:function(){var e=this.drawOptions[this.selectedDrawOption];e&&"polygon"===e.type&&e.lastLoc&&e.initLoc?(this.context.beginPath(),this.context.moveTo(e.lastLoc.x,e.lastLoc.y),this.context.lineTo(e.initLoc.x,e.initLoc.y),this.context.stroke(),this.context.closePath(),this.mousedown=!1,e.initLoc=null,e.lastLoc=null,this.storeCanvas(),this.storeHistory()):e&&"quadratic_curve"===e.type&&0!==e.iteration?(this.context.closePath(),this.storeCanvas(),this.storeHistory(),this.mousedown=!1,e.iteration=0,e.initLoc=null,e.lastLoc=null):e&&"bezier_curve"===e.type&&0!==e.iteration?(this.context.closePath(),this.storeCanvas(),this.storeHistory(),this.mousedown=!1,e.iteration=0,e.initLoc=null,e.firstPoint=null,e.lastPoint=null):"eyedropper"!==e&&!0===this.mousedown&&(this.mousedown=!1,this.storeCanvas(),this.storeHistory()),this.paragraph&&this.paragraph.clearIntervals(Function.prototype.bind.call(function(){this.paragraph=null,this.storeCanvas(),this.storeHistory()},this))},setColor:function(e){e&&(this.colorPicker.value=this.rgbToHex(e.r,e.g,e.b),this.selectedColorOption={r:e.r,g:e.g,b:e.b},this.alphaPicker.value=e.a/255,this.selectedAlphaOption=this.alphaPicker.value,this.alphaPickerPreview&&(this.alphaPickerPreview.innerHTML=v(100*this.selectedAlphaOption)+"%"),this.updatePaintStyle(),this.config.color===this.colorPicker.value&&this.config.alpha===this.selectedAlphaOption||(this.config.color=this.colorPicker.value,this.config.alpha=this.selectedAlphaOption,this.saveData()))},getColorOfCurrentPixel:function(e){n.runtime.sendMessage({method:"get_pixel_color",point:e},this.setColorBinded)},onPrintButtonClick:function(){this.addClass(this.panel,"hide"),p.setTimeout(function(){n.runtime.sendMessage({method:"take_screen_shot"})},100),p.setTimeout(Function.prototype.bind.call(function(){this.removeClass(this.panel,"hide")},this),500)},onControlPanelClick:function(e){if(this.selectedDrawOption!==e){var t=p.document.querySelectorAll("#NOTEPAD_controls .NOTEPAD_controls_draw_option");this.finishLastDrawing();for(var o=0;o<t.length;o++)this.removeClass(t[o],"selected");this.addClass(t[e],"selected"),this.removeClass(this.canvas,"pen"),this.removeClass(this.canvas,"cross"),this.removeClass(this.canvas,"eraser"),this.removeClass(this.canvas,"text"),this.removeClass(this.canvas,"cursor"),this.removeClass(this.canvas,"eyedropper"),this.removeClass(this.canvas,"fill"),this.selectedDrawOption=e;var a=this.drawOptions[this.selectedDrawOption];"pen"===a.type?this.addClass(this.canvas,"pen"):"eraser"===a.type?this.addClass(this.canvas,"eraser"):"text"===a.type?this.addClass(this.canvas,"text"):"cursor"===a.type?this.addClass(this.canvas,"cursor"):"eyedropper"===a.type?this.addClass(this.canvas,"eyedropper"):"fill"===a.type?this.addClass(this.canvas,"fill"):this.addClass(this.canvas,"cross"),this.config.tool!==this.selectedDrawOption&&(this.config.tool=this.selectedDrawOption,this.saveData())}},hexToRgb:function(n){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},rgbToHex:function(n,t,e){return"#"+(16777216+(n<<16)+(t<<8)+e).toString(16).slice(1)},onColorPanelClick:function(e){this.selectedColorOption=this.hexToRgb(e.currentTarget.value),this.updatePaintStyle(),this.config.color!==e.currentTarget.value&&(this.config.color=e.currentTarget.value,this.saveData())},onAlphaChange:function(e){this.selectedAlphaOption=e.currentTarget.value,this.alphaPickerPreview&&(this.alphaPickerPreview.innerHTML=v(100*this.selectedAlphaOption)+"%"),this.updatePaintStyle(),this.config.alpha!==this.selectedAlphaOption&&(this.config.alpha=this.selectedAlphaOption,this.saveData())},onAlphaUpdate:function(e){this.alphaPickerPreview&&(this.alphaPickerPreview.innerHTML=v(100*e.currentTarget.value)+"%")},onLineChange:function(e){this.context.lineWidth=e.currentTarget.value,this.linePickerPreview&&(this.linePickerPreview.innerHTML=v(100*(this.context.lineWidth/20))+"%"),this.config.thickness!==this.context.lineWidth&&(this.config.thickness=this.context.lineWidth,this.saveData())},onLineUpdate:function(e){this.linePickerPreview&&(this.linePickerPreview.innerHTML=v(100*(e.currentTarget.value/20))+"%")},updatePaintStyle:function(){null!==this.selectedColorOption&&null!==this.selectedAlphaOption&&(this.cursor.fillStyle="rgba("+this.selectedColorOption.r+","+this.selectedColorOption.g+","+this.selectedColorOption.b+","+this.selectedAlphaOption+")",this.context.strokeStyle="rgba("+this.selectedColorOption.r+","+this.selectedColorOption.g+","+this.selectedColorOption.b+","+this.selectedAlphaOption+")",this.context.fillStyle="rgba("+this.selectedColorOption.r+","+this.selectedColorOption.g+","+this.selectedColorOption.b+","+this.selectedAlphaOption+")")},addMouseEventListener:function(){var o=Function.prototype.bind.call(this.handleMouseDown,this),t=Function.prototype.bind.call(this.handleMouseMove,this),e=Function.prototype.bind.call(this.handleMouseUp,this),a=Function.prototype.bind.call(this.handleMouseLeave,this);this.canvas.addEventListener("mousedown",o),this.canvas.addEventListener("touchstart",o),this.canvas.addEventListener("mousemove",t),this.canvas.addEventListener("touchmove",t),this.canvas.addEventListener("mouseup",e),this.canvas.addEventListener("touchend",e),this.canvas.addEventListener("mouseleave",a),p.document.addEventListener("keydown",this.keydownBinded),p.document.addEventListener("keypress",this.keypressBinded)},addKeyEventListeners:function(){chrome.storage.local.get(e=>{e.config.hotkeys&&(this.config.hotkeys=e.config.hotkeys,p.document.addEventListener("keydown",this.handleHotKeysDownBinded))})},handleHotKeysDown:function(o){var t=p.event?event:o;if((t.ctrlKey||t.metaKey)&&t.shiftKey)for(var e in this.config.hotkeys)if(this.config.hotkeys.hasOwnProperty(e)&&this.config.hotkeys[e].charCodeAt(0)===t.keyCode){if("eraseAll"==e)return void this.eraseAll();for(var a=0;a<this.drawOptions.length;a++)if(this.drawOptions[a].type===e){this.onControlPanelClick(a);break}break}},matchOutlineColor:function(o,t,e,a){return 255!==o&&255!==t&&255!==e&&0!==a},handleFill:function(d){var t=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),e=4*(d.y*this.canvas.width+d.x),i=t.data[e],n=t.data[e+1],s=t.data[e+2],o=t.data[e+3],a=this.selectedColorOption.r,r=this.selectedColorOption.g,p=this.selectedColorOption.b,c=v(255*this.selectedAlphaOption);i===a&&n===r&&s===p&&o===c||this.matchOutlineColor(i,n,s,o)||(this.floodFill(d.x,d.y,[this.selectedColorOption.r,this.selectedColorOption.g,this.selectedColorOption.b,v(255*this.selectedAlphaOption)],!1,t,0,!0),this.context.putImageData(t,0,0),this.storeCanvas(),this.storeHistory())},floodFill:function(s,t,E,e,o,O){var n,a,i,A=o.data,l=[],d=!1,_=!1,M=o.width,v=o.height,g=new Uint8ClampedArray(M*v),f=4*M,x=s,I=t,S=I*f+4*x,w=A[S],C=A[S+1],b=A[S+2],L=A[S+3],P=!1,H=function(o,t){var e=Math.abs;if(0>o||0>t||v<=t||M<=o)return!1;var a=t*f+4*o,i=y(e(w-A[a]),e(C-A[a+1]),e(b-A[a+2]),e(L-A[a+3]));i<O&&(i=0);var r=e(0-g[t*M+o]);return P||0!==i&&255!==r&&(A[a]=E[0],A[a+1]=E[1],A[a+2]=E[2],A[a+3]=(E[3]+A[a+3])/2,g[t*M+o]=255),0===i+r};for(l.push([x,I]);l.length;){var D=l.pop();for(x=D[0],I=D[1],P=!0;H(x,I-1);)I-=1;for(P=!1,e&&(!H(x-1,I)&&H(x-1,I-1)&&l.push([x-1,I-1]),!H(x+1,I)&&H(x+1,I-1)&&l.push([x+1,I-1])),_=d=!1;H(x,I);)A[i=(a=I)*f+4*(n=x)]=E[0],A[i+1]=E[1],A[i+2]=E[2],A[i+3]=E[3],g[a*M+n]=255,H(x-1,I)?d||(l.push([x-1,I]),d=!0):d&&(d=!1),H(x+1,I)?_||(l.push([x+1,I]),_=!0):_&&(_=!1),I+=1;e&&(H(x-1,I)&&!d&&l.push([x-1,I]),H(x+1,I)&&!_&&l.push([x+1,I]))}},handleKeyDown:function(e){this.paragraph&&(8!==e.keyCode&&13!==e.keyCode||e.preventDefault(),8===e.keyCode?this.paragraph.backspace():13===e.keyCode&&this.paragraph.newline())},handleKeyPress:function(n){if(this.paragraph){var t=String.fromCharCode(n.which);if(8!==n.keyCode&&!n.ctrlKey&&!n.metaKey){n.preventDefault();var e=this.drawOptions[this.selectedDrawOption];this.context.font=e.minSize+(e.maxSize-e.minSize)*this.context.lineWidth/20+"px "+e.font,this.paragraph.insert(t)}}},handleMouseDown:function(n){n.preventDefault(),this.mousedown=!0;var t=this.drawOptions[this.selectedDrawOption];if(this.lastMouseDownLoc=this.windowToCanvas(n.clientX,n.clientY),"pen"===t.type)this.context.beginPath(),this.context.moveTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y+16);else if("eyedropper"===t.type)this.getColorOfCurrentPixel({x:v(p.devicePixelRatio*(void 0===n.clientX?n.touches[0].clientX:n.clientX-2)),y:v(p.devicePixelRatio*(void 0===n.clientY?n.touches[0].clientY:n.clientY+22))});else if("line"===t.type)this.storeCanvas();else if("quadratic_curve"===t.type){if(0===t.iteration)this.storeCanvas(),t.initLoc={x:this.lastMouseDownLoc.x,y:this.lastMouseDownLoc.y};else if(1!==t.iteration)throw new Error("invalid iteration");}else if("bezier_curve"===t.type){if(0===t.iteration)this.storeCanvas(),t.initLoc={x:this.lastMouseDownLoc.x,y:this.lastMouseDownLoc.y};else if(1===t.iteration);else if(2!==t.iteration)throw new Error("invalid iteration");}else if("polygon"===t.type)this.storeCanvas(),t.lastLoc?(this.context.beginPath(),this.context.moveTo(t.lastLoc.x,t.lastLoc.y),this.context.lineTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y),this.context.stroke()):(t.lastLoc={x:this.lastMouseDownLoc.x,y:this.lastMouseDownLoc.y},t.initLoc={x:this.lastMouseDownLoc.x,y:this.lastMouseDownLoc.y});else if("circle"===t.type)this.storeCanvas();else if("rectangle"===t.type)this.storeCanvas();else if("eraser"===t.type)this.restoreCanvas(),this.context.save(),this.context.translate(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y),this.context.clearRect(0,0,t.width,t.height),this.context.restore();else if("fill"===t.type)this.handleFill(this.lastMouseDownLoc);else if("text"===t.type)if(this.cursor.erase(this.context,this.drawingSurfaceImageData),this.storeCanvas(),this.paragraph&&this.paragraph.isPointInside(this.lastMouseDownLoc))this.paragraph.moveCursorCloseTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y);else{this.paragraph&&(this.paragraph.clearIntervals(),this.paragraph=null);var e=this.context.measureText("W").width;e+=e/6,this.paragraph=new Paragraph(this.context,this.lastMouseDownLoc.x,this.lastMouseDownLoc.y-e,this.drawingSurfaceImageData,this.cursor),this.paragraph.addLine(new TextLine(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y))}},handleMouseMove:function(n){var t=Math.sin,o=Math.cos,a=Math.PI,r=Math.atan2;n.preventDefault();const s=this.drawOptions[this.selectedDrawOption],e=this.windowToCanvas(void 0===n.clientX?n.touches[0].clientX:n.clientX,void 0===n.clientY?n.touches[0].clientY:n.clientY);if(this.setLineProperty(),this.mousedown||"eraser"!=s.type||(this.restoreCanvas(),this.context.save(),this.context.translate(e.x,e.y),this.context.clearRect(0,0,s.width,s.height),this.context.restore()),"quadratic_curve"===s.type?s.iteration&&s.lastLoc&&(this.restoreCanvas(),this.context.beginPath(),this.context.moveTo(s.initLoc.x,s.initLoc.y),this.context.quadraticCurveTo(e.x,e.y,s.lastLoc.x,s.lastLoc.y),this.context.stroke()):"bezier_curve"===s.type&&(1===s.iteration&&s.firstPoint?(this.restoreCanvas(),this.context.beginPath(),this.context.moveTo(s.initLoc.x,s.initLoc.y),this.context.quadraticCurveTo(e.x,e.y,s.firstPoint.x,s.firstPoint.y),this.context.stroke()):2===s.iteration&&s.firstPoint&&s.lastPoint&&(this.restoreCanvas(),this.context.beginPath(),this.context.moveTo(s.initLoc.x,s.initLoc.y),this.context.bezierCurveTo(s.lastPoint.x,s.lastPoint.y,e.x,e.y,s.firstPoint.x,s.firstPoint.y),this.context.stroke())),this.mousedown)if("pen"===s.type)this.restoreCanvas(),this.context.lineTo(e.x,e.y+16),this.context.stroke();else if("line"===s.type)this.restoreCanvas(),this.context.beginPath(),this.context.moveTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y),this.context.lineTo(e.x,e.y),this.context.stroke();else if("arrow"===s.type){this.restoreCanvas(),this.context.beginPath();const n=e.x-this.lastMouseDownLoc.x,i=e.y-this.lastMouseDownLoc.y,s=r(i,n);this.context.moveTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y),this.context.lineTo(e.x,e.y),this.context.lineTo(e.x-20*o(s-a/6),e.y-20*t(s-a/6)),this.context.moveTo(e.x,e.y),this.context.lineTo(e.x-20*o(s+a/6),e.y-20*t(s+a/6)),this.context.stroke()}else if("quadratic_curve"===s.type)0===s.iteration&&(this.restoreCanvas(),this.context.beginPath(),this.context.moveTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y),this.context.lineTo(e.x,e.y),this.context.stroke());else if("bezier_curve"===s.type)0===s.iteration&&(this.restoreCanvas(),this.context.beginPath(),this.context.moveTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y),this.context.lineTo(e.x,e.y),this.context.stroke());else if("polygon"===s.type)this.restoreCanvas(),this.context.beginPath(),this.context.moveTo(s.lastLoc.x,s.lastLoc.y),this.context.lineTo(e.x,e.y),this.context.stroke();else if("circle"===s.type)this.restoreCanvas(),this.drawEllipse(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y,e.x-this.lastMouseDownLoc.x,e.y-this.lastMouseDownLoc.y);else if("rectangle"===s.type)this.restoreCanvas(),this.context.beginPath(),this.context.moveTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y),this.context.lineTo(this.lastMouseDownLoc.x,e.y),this.context.lineTo(e.x,e.y),this.context.lineTo(e.x,this.lastMouseDownLoc.y),this.context.lineTo(this.lastMouseDownLoc.x,this.lastMouseDownLoc.y),this.context.stroke();else if("eraser"===s.type)this.context.save(),this.context.translate(e.x,e.y),this.context.clearRect(0,0,s.width,s.height),this.context.restore();else;},handleMouseUp:function(n){n.preventDefault(),this.mousedown=!1;var t=this.drawOptions[this.selectedDrawOption],e=this.windowToCanvas(void 0===n.clientX?n.changedTouches[0].clientX:n.clientX,void 0===n.clientY?n.changedTouches[0].clientY:n.clientY);"arrow"===t.type&&(this.context.closePath(),this.storeCanvas(),this.storeHistory()),"pen"===t.type?(this.context.closePath(),this.storeCanvas(),this.storeHistory()):"line"===t.type?(this.context.closePath(),this.storeCanvas(),this.storeHistory()):"quadratic_curve"===t.type?0===t.iteration?(t.lastLoc={x:e.x,y:e.y},t.iteration++):1===t.iteration&&(this.context.closePath(),this.storeCanvas(),this.storeHistory(),t.iteration=0,t.initLoc=null,t.lastLoc=null):"bezier_curve"===t.type?0===t.iteration?(t.firstPoint={x:e.x,y:e.y},t.iteration++):1===t.iteration?(t.lastPoint={x:e.x,y:e.y},t.iteration++):2===t.iteration&&(this.context.closePath(),this.storeCanvas(),this.storeHistory(),t.iteration=0,t.initLoc=null,t.firstPoint=null,t.lastPoint=null):"polygon"===t.type?(this.storeCanvas(),this.storeHistory(),t.lastLoc={x:e.x,y:e.y}):"circle"===t.type?(this.storeCanvas(),this.storeHistory()):"rectangle"===t.type?(this.context.closePath(),this.storeCanvas(),this.storeHistory()):"eraser"===t.type&&(this.storeCanvas(),this.storeHistory())},handleMouseLeave:function(){"eraser"===this.drawOptions[this.selectedDrawOption].type&&this.restoreCanvas()},setLineProperty:function(){this.context.lineJoin="round",this.context.lineCap="round"},drawEllipse:function(l,t,e,i){var n=.5522848*(e/2),s=.5522848*(i/2),o=l+e,a=t+i,r=l+e/2,d=t+i/2;this.context.beginPath(),this.context.moveTo(l,d),this.context.bezierCurveTo(l,d-s,r-n,t,r,t),this.context.bezierCurveTo(r+n,t,o,d-s,o,d),this.context.bezierCurveTo(o,d+s,r+n,a,r,a),this.context.bezierCurveTo(r-n,a,l,d+s,l,d),this.context.stroke()},addClass:function(n,t){0<=n.className.indexOf(t)||(n.className=n.className+" "+t)},removeClass:function(n,t){n.className=n.className.replace(new RegExp("\\b"+t+"\\b","g"),"")},triggerClick:function(e){this.triggerEvent(e,"click")},triggerEvent:function(n,t){var e;document.createEvent?(e=document.createEvent("HTMLEvents")).initEvent(t,!0,!0):document.createEventObject&&((e=document.createEventObject()).eventType=t),e.eventName=t,n.dispatchEvent?n.dispatchEvent(e):n.fireEvent&&htmlEvents["on"+t]?n.fireEvent("on"+e.eventType,e):n[t]?n[t]():n["on"+t]&&n["on"+t]()},initDragging:function(){this.panel.addEventListener("mousedown",this.handleDraggingStart),this.panel.addEventListener("touchstart",this.handleDraggingStart),p.document.addEventListener("mouseup",this.handleDragDone),p.document.addEventListener("touchend",this.handleDragDone)},handleDraggingStart:function(e){o.pos_x=this.getBoundingClientRect().left-(void 0===e.clientX?e.touches[0].clientX:e.clientX),o.pos_y=this.getBoundingClientRect().top-(void 0===e.clientY?e.touches[0].clientY:e.clientY),this.addEventListener("mousemove",o.handleDragging),this.addEventListener("touchmove",o.handleDragging)},handleDragging:function(e){"INPUT"!==e.target.nodeName.toUpperCase()&&(e.preventDefault(),this.style.top=(void 0===e.clientY?e.touches[0].clientY:e.clientY)+o.pos_y+"px",this.style.left=(void 0===e.clientX?e.touches[0].clientX:e.clientX)+o.pos_x+"px")},handleDragDone:function(){o.panel.removeEventListener("mousemove",o.handleDragging),o.panel.removeEventListener("touchmove",o.handleDragging)},windowToCanvas:function(n,t){var e=this.canvas.getBoundingClientRect();return{x:v(n)-e.left*(this.canvas.width/e.width),y:v(t)-e.top*(this.canvas.height/e.height)}},handlePostMessageResponse:function(n){if(n.origin===p.location.origin){var t=n.data;"get_pixel_color_response"===t.method?this.setColor(t.response):"get_data_response"===t.method&&this.render(t.response)}},exit:function(){this.canvas.parentNode.removeChild(this.canvas),this.panel.parentNode.removeChild(this.panel),p.document.removeEventListener("keydown",this.keydownBinded),p.document.removeEventListener("keypress",this.keypressBinded),p.document.removeEventListener("keydown",this.handleHotKeysDownBinded),p.document.removeEventListener("mouseup",this.handleDragDone),p.removeEventListener("resize",this.resizeBinded),p.removeEventListener("scroll",this.resizeBinded),this.canvas=null,this.context=null,this.selectedDrawOption=null,this.selectedColorOption=null,this.selectedAlphaOption=null,this.mousedown=!1,this.lastMouseDownLoc=null,this.drawingSurfaceImageData=null,this.paragraph=null,this.panel=null,this.initialized=!1,this.controlPanelHidden=!1,"undefined"!=typeof unsafeWindow&&null!==unsafeWindow&&(unsafeWindow.NOTEPAD_INIT=!1,unsafeWindow.CTRL_HIDDEN=!1)},eraseAll:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.paragraph&&(this.paragraph.clearIntervals(),this.paragraph=null),this.storeCanvas(!0),this.storeHistory(),p.localStorage.removeItem("WP_CRX_STORAGE_SNAPSHOT_"+p.location.pathname)},hideControlPanel:function(){this.addClass(this.panel,"hide"),this.controlPanelHidden=!0,"undefined"!=typeof unsafeWindow&&null!==unsafeWindow&&(unsafeWindow.CTRL_HIDDEN=!0)},showControlPanel:function(){this.removeClass(this.panel,"hide"),this.controlPanelHidden=!1,"undefined"!=typeof unsafeWindow&&null!==unsafeWindow&&(unsafeWindow.CTRL_HIDDEN=!1)},saveData:function(){n.runtime.sendMessage({method:"save_data",config:this.config})},render:function(e){this.config=e||{},this.createCanvas(),this.setLineProperty(),this.createControlPanel(),this.initDragging(),this.addMouseEventListener(),this.addKeyEventListeners()},initConfig:function(){n.runtime.sendMessage({method:"get_data"},this.renderBinded)},init:function(){this.history=new m,this.CSSAnimationManager=getCSSAnimationManager(),this.setColorBinded=Function.prototype.bind.call(this.setColor,this),this.renderBinded=Function.prototype.bind.call(this.render,this),this.handlePostMessageResponseBinded=Function.prototype.bind.call(this.handlePostMessageResponse,this),this.keydownBinded=Function.prototype.bind.call(this.handleKeyDown,this),this.keypressBinded=Function.prototype.bind.call(this.handleKeyPress,this),this.handleHotKeysDownBinded=Function.prototype.bind.call(this.handleHotKeysDown,this),this.persistLocalStorageBinded=Function.prototype.bind.call(this.persistLocalStorage,this),this.resizeBinded=Function.prototype.bind.call(function(){this.resizeTimeoutID&&(this.resizeTimeoutID=p.clearTimeout(this.resizeTimeoutID)),this.resizeTimeoutID=p.setTimeout(Function.prototype.bind.call(this.handleResize,this),200)},this),this.initConfig(),this.initialized=!0,"undefined"!=typeof unsafeWindow&&null!==unsafeWindow&&(unsafeWindow.NOTEPAD_INIT=!0)}};return o});